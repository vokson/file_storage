import logging
from uuid import uuid4
from typing import AsyncGenerator, Awaitable

from backend.domain import commands
from backend.service_layer.uow import AbstractUnitOfWork
from backend.api.responses.abstract import EmptyResponse
from backend.api.responses.files import FileResponse
from backend.domain.models import Link
from backend.core.config import settings, tz_now

logger = logging.getLogger(__name__)

async def add_for_download(
    cmd: commands.AddLink,
    uow: AbstractUnitOfWork,
) -> Link:
    async with uow:
        model = Link(
            id=uuid4(),
            file_id=cmd.file_id,
            type=uow.link_repository.DOWNLOAD_LINK_TYPE,
            created=tz_now(),
            expired=tz_now(settings.storage_time_for_links)
        )

        await uow.link_repository.add(model)
        await uow.commit()
        return model
